<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sabah Property Finder Pro - Advanced</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Libraries (Free CDNs) -->
    <link rel="stylesheet" href="https://kendo.cdn.telerik.com/themes/8.0.1/default/default-main.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #1e4e79;
            --secondary-color: #4a90e2;
            --accent-color: #ff6b6b;
            --light-color: #ffffff;
            --bg-color: #f4f7fc;
            --text-dark: #343a40;
            --text-light: #6c757d;
            --border-color: #e0e6ed;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --font-family: 'Poppins', 'Segoe UI', sans-serif;
        }
        html, body { margin: 0; padding: 0; height: 100%; font-family: var(--font-family); background-color: var(--bg-color); overflow: hidden; font-size: 15px; }
        * { box-sizing: border-box; }
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        .app-header { background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%); color: white; padding: 12px 25px; display: flex; align-items: center; gap: 15px; box-shadow: 0 4px 12px var(--shadow-color); z-index: 1010; }
        .app-header h1 { font-size: 24px; font-weight: 600; margin: 0; }
        .app-main-content { display: flex; flex-grow: 1; height: calc(100% - 66px); }
        .sidebar { width: 450px; background-color: var(--light-color); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; flex-shrink: 0; transition: width 0.3s ease; }
        
        /* Search Panel Styling */
        .search-panel { padding: 20px; border-bottom: 1px solid var(--border-color); }
        .primary-search-container { display: flex; gap: 10px; margin-bottom: 15px; }
        #textSearch { flex-grow: 1; }
        #advancedFiltersToggle { flex-shrink: 0; }
        .advanced-filters-container { display: none; padding-top: 20px; border-top: 1px dashed var(--border-color); margin-top: 20px; }
        .filter-group { margin-bottom: 18px; }
        .filter-group label { display: block; font-weight: 500; color: var(--text-dark); margin-bottom: 8px; font-size: 14px; }
        .k-rangeslider .k-slider-track-wrap { height: 4px; } /* Thinner slider */
        .search-actions { display: flex; gap: 10px; margin-top: 20px; }
        .search-actions button { flex-grow: 1; }

        /* Results Panel Styling */
        .results-header { padding: 12px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .results-header h2 { font-size: 18px; color: var(--primary-color); margin: 0; font-weight: 600; }
        #resultsCount { font-size: 14px; color: var(--text-light); }
        .results-panel { flex-grow: 1; overflow-y: auto; }
        #resultsChart { height: 180px; margin: 15px; }
        .results-list { padding: 0 15px 15px; }
        .property-card { background: var(--light-color); border: 1px solid var(--border-color); border-radius: 10px; padding: 18px; margin-bottom: 15px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px var(--shadow-color); position: relative; border-left: 5px solid var(--secondary-color); }
        .property-card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12); border-left-color: var(--accent-color); }
        .property-card.highlighted { background-color: #e9f5ff; border-color: var(--secondary-color); box-shadow: 0 8px 20px rgba(74, 144, 226, 0.3); }
        .property-card h3 { margin: 0 0 5px; font-size: 18px; color: var(--primary-color); font-weight: 600; }
        .property-card .property-locality { font-size: 14px; color: var(--text-light); margin-bottom: 12px; }
        .property-card .property-price { font-size: 17px; font-weight: 700; color: var(--accent-color); margin: 10px 0; }
        .property-card i { margin-right: 8px; color: var(--text-light); width: 16px; text-align: center; }
        .property-meta { display: flex; gap: 8px; margin-top: 15px; padding-top: 12px; border-top: 1px solid var(--border-color); flex-wrap: wrap; }
        .property-meta span { font-size: 11px; background-color: #eef2f7; color: var(--primary-color); padding: 4px 10px; border-radius: 15px; font-weight: 500; }
        .property-card-icon { position: absolute; top: 15px; right: 15px; font-size: 20px; color: var(--border-color); }
        
        /* Map & Status Indicators */
        .map-container { flex-grow: 1; position: relative; }
        #map { width: 100%; height: 100%; background: #e9ecef; }
        .status-indicator { text-align: center; padding: 60px 20px; color: var(--text-light); }
        .loading-spinner { border: 4px solid var(--bg-color); border-top: 4px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media (max-width: 900px) { .app-main-content { flex-direction: column-reverse; } .sidebar { width: 100%; height: 45%; border-right: none; border-top: 1px solid var(--border-color); } .map-container { height: 55%; } .app-header h1 { font-size: 20px; } }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="app-header">
            <i class="fa-solid fa-map-location-dot fa-xl"></i>
            <h1>Sabah Property Finder Pro</h1>
        </header>

        <main class="app-main-content">
            <aside class="sidebar">
                <div class="search-panel">
                    <div class="primary-search-container">
                        <input id="textSearch" placeholder="Search by name, ID, or keyword..."/>
                        <button id="advancedFiltersToggle" class="k-button-secondary"><i class="fa-solid fa-sliders"></i></button>
                    </div>

                    <div class="advanced-filters-container" id="advancedFilters">
                        <div class="filter-group">
                            <label for="filterCategories">Property Category</label>
                            <input id="filterCategories" />
                        </div>
                        <div class="filter-group">
                            <label for="filterZone">Zone</label>
                            <input id="filterZone" />
                        </div>
                        <div class="filter-group">
                            <label for="filterLocality">Locality / Taman</label>
                            <input id="filterLocality" />
                        </div>
                        <div class="filter-group">
                            <label>Market Value (MYR)</label>
                            <div id="filterMarketValue"></div>
                        </div>
                         <div class="filter-group">
                            <label for="filterSortBy">Sort Results By</label>
                            <input id="filterSortBy" />
                        </div>
                    </div>

                    <div class="search-actions">
                        <button id="searchButton"><i class="fa-solid fa-search"></i> Search</button>
                        <button id="clearButton" class="k-button-secondary"><i class="fa-solid fa-eraser"></i> Clear</button>
                    </div>
                </div>
                
                <div class="results-header">
                    <h2>Search Results</h2>
                    <span id="resultsCount">0 properties</span>
                </div>
                <div class="results-panel" id="resultsPanel">
                    <div id="resultsChart"></div>
                    <div class="results-list" id="resultsContent">
                         <div class="status-indicator" id="initialMessage">
                            <i class="fa-solid fa-house-chimney-window fa-3x" style="color:var(--border-color); margin-bottom: 20px;"></i>
                            <h3>Find Your Next Property</h3>
                            <p>Use the search bar or advanced filters to begin.</p>
                        </div>
                        <div class="status-indicator" id="loadingIndicator" style="display: none;">
                            <div class="loading-spinner"></div>
                            <h3>Searching Properties...</h3>
                        </div>
                    </div>
                </div>
            </aside>
            <section class="map-container">
                <div id="map"></div>
            </section>
        </main>
    </div>

    <!-- Core Libraries (Free CDNs) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://kendo.cdn.telerik.com/2025.2.520/js/kendo.all.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <script>
        $(document).ready(function() {
            // --- CONFIGURATION ---
            const WEBHOOK_URL = 'https://earthinfointern.dxlxz01.uk/webhook-test/15466b8b-8d75-4fbe-90a3-42724cc92fc4';
            const SABAH_CENTER = [5.9804, 116.0735];
            let drawnSearchArea = null; // To store the user-drawn Leaflet layer

            // --- KENDO UI WIDGET INITIALIZATION ---
            $("#textSearch").kendoTextBox({});
            $("#advancedFiltersToggle").kendoButton({
                icon: "sliders",
                toggle: true,
                onToggle: (e) => { $("#advancedFilters").slideToggle(e.checked); }
            });
            $("#searchButton").kendoButton({ themeColor: 'primary' });
            $("#clearButton").kendoButton();

            // Advanced Filter Widgets
            $("#filterCategories").kendoMultiSelect({
                placeholder: "Select categories...",
                dataTextField: "text",
                dataValueField: "value",
                dataSource: [
                    { text: "Residential", value: "Residential" },
                    { text: "Commercial", value: "Commercial" },
                    { text: "Land", value: "Land" },
                    { text: "Government", value: "Government" }
                ]
            });

            $("#filterZone").kendoAutoComplete({
                placeholder: "e.g., Kota Kinabalu, Penampang...",
                dataSource: ["Kota Kinabalu", "Penampang", "Tuaran", "Papar", "Putatan", "Sandakan", "Tawau"] // Sample data
            });

            $("#filterLocality").kendoAutoComplete({
                placeholder: "e.g., Luyang, Kepayan, Damai...",
                dataSource: ["Luyang", "Kepayan", "Damai", "Foh Sang", "Inanam", "Menggatal"] // Sample data
            });

            $("#filterMarketValue").kendoRangeSlider({
                min: 0, max: 5000000,
                smallStep: 50000, largeStep: 250000,
                tickPlacement: 'none',
                value: [0, 5000000] // FIX: Provide initial value
            });

            $("#filterSortBy").kendoDropDownList({
                dataTextField: "text", dataValueField: "value",
                dataSource: [
                    { text: "Best Match", value: "best_match,DESC" },
                    { text: "Price (High to Low)", value: "marketValue,DESC" },
                    { text: "Price (Low to High)", value: "marketValue,ASC" },
                    { text: "Name (A-Z)", value: "propertyName,ASC" }
                ],
                value: "best_match,DESC"
            });

            // --- MAP INITIALIZATION ---
            const map = L.map('map').setView(SABAH_CENTER, 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
            const propertyMarkers = L.layerGroup().addTo(map);

            // Initialize Leaflet.draw
            const drawnItems = new L.FeatureGroup().addTo(map);
            const drawControl = new L.Control.Draw({
                draw: {
                    polygon: true,
                    rectangle: true,
                    circle: false,
                    marker: false,
                    polyline: false,
                    circlemarker: false
                },
                edit: { featureGroup: drawnItems }
            });
            map.addControl(drawControl);

            map.on(L.Draw.Event.CREATED, function (event) {
                drawnItems.clearLayers(); // Only allow one drawn area at a time
                const layer = event.layer;
                drawnItems.addLayer(layer);
                drawnSearchArea = layer.toGeoJSON(); // Store the drawn shape as GeoJSON
            });
             map.on(L.Draw.Event.DELETED, function () {
                drawnSearchArea = null; // Clear the stored shape
            });

            // --- CORE FUNCTIONS ---

            function buildSearchPayload() {
                const valueSlider = $("#filterMarketValue").data("kendoRangeSlider").value();
                const sortValue = $("#filterSortBy").data("kendoDropDownList").value().split(',');

                const payload = {
                    textSearch: $("#textSearch").val() || null,
                    filters: {
                        categories: $("#filterCategories").data("kendoMultiSelect").value(),
                        marketValue: {
                            min: valueSlider[0],
                            max: valueSlider[1]
                        },
                        locations: []
                    },
                    mapView: {
                        bounds: map.getBounds(),
                        applyBoundsFilter: !drawnSearchArea, // Only apply bounds if no specific area is drawn
                        drawnGeoJSON: drawnSearchArea
                    },
                    resultsControl: {
                        limit: 50, // Can be replaced with a dropdown if needed
                        sortBy: sortValue[0],
                        sortOrder: sortValue[1]
                    }
                };

                const zone = $("#filterZone").val();
                if (zone) payload.filters.locations.push({ type: "zone", value: zone });

                const locality = $("#filterLocality").val();
                if (locality) payload.filters.locations.push({ type: "locality", value: locality });
                
                // Clean up empty filters
                if (payload.filters.categories.length === 0) delete payload.filters.categories;
                if (payload.filters.locations.length === 0) delete payload.filters.locations;

                return payload;
            }

            function fetchProperties() {
                const payload = buildSearchPayload();
                console.log("Sending Payload:", JSON.stringify(payload, null, 2)); // For debugging

                showLoading(true);
                $.ajax({
                    url: WEBHOOK_URL, type: 'POST', contentType: 'application/json',
                    data: JSON.stringify(payload),
                    success: updateResults,
                    error: (xhr, status, error) => {
                        console.error("Error fetching data:", error);
                        showNoResults();
                        $("#resultsCount").text("Error");
                    },
                    complete: () => showLoading(false)
                });
            }

            function updateResults(responseArray) {
                const resultsContent = $("#resultsContent");
                resultsContent.empty(); propertyMarkers.clearLayers();
                
                if (!Array.isArray(responseArray) || responseArray.length === 0 || (responseArray[0] && !responseArray[0].targetPropertyFound)) {
                    showNoResults(); $("#resultsCount").text("0 properties");
                    updateChart([]);
                    return;
                }
                
                const properties = responseArray.map(item => item.targetPropertyData);

                properties.forEach(property => {
                    createPropertyCard(property, resultsContent);
                    createPropertyMarker(property, propertyMarkers);
                });

                $("#resultsCount").text(`${properties.length} ${properties.length === 1 ? 'property' : 'properties'}`);
                if (properties.length > 0) {
                    map.fitBounds(propertyMarkers.getBounds(), { padding: [50, 50] });
                }
                updateChart(properties);
            }
            
            function updateChart(properties) {
                const chartData = properties.reduce((acc, prop) => {
                    const category = prop.category || 'Unknown';
                    const existing = acc.find(item => item.category === category);
                    if (existing) {
                        existing.value++;
                    } else {
                        acc.push({ category: category, value: 1 });
                    }
                    return acc;
                }, []);

                $("#resultsChart").kendoChart({
                    title: { text: "Property Types Found", font: "14px Poppins" },
                    legend: { position: "bottom" },
                    seriesDefaults: { type: "pie", labels: { visible: true, background: "transparent", format: "{0:N0}" } },
                    series: [{ data: chartData }],
                    tooltip: { visible: true, format: "{0} properties" }
                });
            }

            function clearSearch() {
                // Reset text and widgets
                $("#textSearch").data("kendoTextBox").value("");
                $("#filterCategories").data("kendoMultiSelect").value([]);
                $("#filterZone").data("kendoAutoComplete").value("");
                $("#filterLocality").data("kendoAutoComplete").value("");
                $("#filterMarketValue").data("kendoRangeSlider").value([0, 5000000]);
                $("#filterSortBy").data("kendoDropDownList").value("best_match,DESC");

                // Clear map and results
                drawnItems.clearLayers();
                drawnSearchArea = null;
                propertyMarkers.clearLayers();
                $("#resultsContent").html($("#initialMessage").clone().show());
                $("#resultsCount").text("0 properties");
                updateChart([]);
                map.flyTo(SABAH_CENTER, 10);
            }

            // --- UI & HELPER FUNCTIONS (Mostly unchanged) ---
            function showLoading(show) { $("#loadingIndicator").toggle(show); if (show) $("#initialMessage, .property-card, .no-results").remove(); }
            function showNoResults() { $("#resultsContent").html('<div class="status-indicator no-results"><i class="fa-solid fa-magnifying-glass fa-3x" style="color:var(--border-color); margin-bottom: 20px;"></i><h3>No Properties Found</h3><p>Try adjusting your search filters.</p></div>'); }
            function formatCurrency(value) { return (value === null || isNaN(value)) ? 'N/A' : new Intl.NumberFormat('en-MY', { style: 'currency', currency: 'MYR' }).format(value); }
            const getCategoryInfo = (categoryString) => ({ color: '#4a90e2', icon: 'fa-building' }); // Simplified for brevity

            function createPropertyCard(property, container) {
                const card = $(`
                    <div class="property-card" data-id="${property.propertyId}">
                        <h3>${property.propertyName || 'Unnamed Property'}</h3>
                        <p class="property-locality"><i class="fa-solid fa-map-pin"></i>${property.locality || 'N/A'}</p>
                        <p class="property-price"><i class="fa-solid fa-dollar-sign"></i>${formatCurrency(property.marketValue)}</p>
                    </div>
                `);
                card.on('click', () => { /* ... click logic ... */ });
                container.append(card);
            }

            function createPropertyMarker(property, layerGroup) {
                const marker = L.marker([property.latitude, property.longitude]).addTo(layerGroup);
                marker.propertyId = property.propertyId;
                marker.bindPopup(`<h3>${property.propertyName}</h3><p>Value: ${formatCurrency(property.marketValue)}</p>`);
            }

            // --- EVENT LISTENERS ---
            $("#searchButton").on("click", fetchProperties);
            $("#textSearch").on("keydown", e => { if (e.key === 'Enter') fetchProperties(); });
            $("#clearButton").on("click", clearSearch);
            
            // Initial setup
            updateChart([]); // Initialize empty chart
        });
    </script>
</body>
</html>
